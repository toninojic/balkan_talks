document.addEventListener("DOMContentLoaded", function () {
    const revealCards = function (root) {
        const cards = (root || document).querySelectorAll(".post-card:not(.is-visible)");

        cards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add("is-visible");
            }, index * 55);
        });
    };

    revealCards(document);

    document.querySelectorAll("#load-more-button").forEach(function (loadMoreBtn) {
        loadMoreBtn.addEventListener("click", function () {
            let parentWrapper = loadMoreBtn.parentElement;
            let postContainer = parentWrapper.querySelector(".post-container");

            if (!postContainer) {
                console.error("Post container not found near load more button.");
                return;
            }

            let offset = parseInt(loadMoreBtn.getAttribute("data-offset"));
            let category = loadMoreBtn.getAttribute("data-category") || null;
            let tag = loadMoreBtn.getAttribute("data-tag") || null;
            let postsPerPage = parseInt(loadMoreBtn.getAttribute("data-posts-per-page")) || 6;
            let layout = postContainer.getAttribute("data-layout") || "default";

            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = "Loading...";

            fetch(data.ajax_url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
                },
                body: new URLSearchParams({
                    action: "load_more_posts",
                    security: data.nonce,
                    offset: offset,
                    category: category,
                    tag: tag,
                    posts_per_page: postsPerPage,
                    layout: layout
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        if (result.data.trim() !== "") {
                            const tempContainer = document.createElement("div");
                            tempContainer.innerHTML = result.data;

                            if (layout === "swiper") {
                                const newSlides = Array.from(tempContainer.children).map((el) => el.outerHTML);
                                const swiperInstance = postContainer.btSwiper;
                                const swiperWrapper = postContainer.querySelector(".swiper-wrapper");

                                if (swiperInstance && typeof swiperInstance.appendSlide === "function") {
                                    swiperInstance.appendSlide(newSlides);
                                    swiperInstance.update();
                                } else if (swiperWrapper) {
                                    while (tempContainer.firstChild) {
                                        swiperWrapper.appendChild(tempContainer.firstChild);
                                    }
                                }
                            } else {
                                while (tempContainer.firstChild) {
                                    postContainer.appendChild(tempContainer.firstChild);
                                }
                            }

                            revealCards(postContainer);
                            loadMoreBtn.setAttribute("data-offset", offset + postsPerPage);
                            loadMoreBtn.disabled = false;
                            loadMoreBtn.textContent = "Load More";
                        } else {
                            loadMoreBtn.textContent = "No more posts";
                            loadMoreBtn.disabled = true;
                        }
                    } else {
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = "Load More";
                        console.error("Error while loading posts.");
                    }
                })
                .catch(error => {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = "Load More";
                    console.error("Error while sending request:", error);
                });
        });
    });
});

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".post-container--swiper").forEach(function (swiperContainer) {
        if (typeof Swiper === "undefined") {
            return;
        }

        swiperContainer.btSwiper = new Swiper(swiperContainer, {
            slidesPerView: 1.2,
            spaceBetween: 20,
            centeredSlides: true,
            loop: true,
            speed: 750,
            grabCursor: true,
            effect: "coverflow",
            coverflowEffect: {
                rotate: 0,
                stretch: 0,
                depth: 100,
                modifier: 1,
                slideShadows: false
            },
            pagination: {
                el: swiperContainer.querySelector(".swiper-pagination"),
                clickable: true
            },
            breakpoints: {
                768: {
                    slidesPerView: 2.2,
                    spaceBetween: 24
                },
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 30
                }
            }
        });
    });
});

// Hamburger menu toggle
document.addEventListener("DOMContentLoaded", function () {
    let hamburgerMenu = document.querySelector(".hamburger-menu");
    let mainMenu = document.querySelector("#main-menu");

    if (hamburgerMenu && mainMenu) {
        hamburgerMenu.addEventListener("click", function () {
            mainMenu.classList.toggle("active");
        });
    }

    let hamburgerIcon = document.querySelector(".hamburger");
    if (hamburgerIcon) {
        hamburgerIcon.addEventListener("click", function () {
            hamburgerIcon.classList.toggle("is-active");
        });
    }
});

document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("in-content-search");
    const content = document.getElementById("searchable-content");

    if (searchInput && content) {
        searchInput.addEventListener("input", function () {
            const keyword = this.value.toLowerCase();
            const children = content.querySelectorAll("p, li, h2, h3, h4");

            children.forEach(el => {
                const text = el.textContent.toLowerCase();
                el.style.display = text.includes(keyword) ? "block" : "none";
            });
        });
    }
});
